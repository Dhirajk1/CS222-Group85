"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("path"),s=require("camelcase"),t=require("slash"),n=require("fs"),o=require("child_process");function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=r(e),i=r(s),l=r(t),a=r(n);function u(e){return l.default(e.split(process.cwd())[1])}const d="./node_modules/.cache/jest-preview";function p(e=document.body){a.default.existsSync(d)||a.default.mkdirSync(d,{recursive:!0});const s=Array.from(document.head.children).reduce(((e,s)=>e+s.outerHTML),"");a.default.writeFileSync(c.default.join(d,"head.html"),s),a.default.writeFileSync(c.default.join(d,"body.html"),e.outerHTML)}function f(){a.default.existsSync(d)||a.default.mkdirSync(d,{recursive:!0})}function m(e){const s=e;return(e,t,n)=>{let o;return o=t?async function(...e){try{return await t(...e)}catch(e){throw p(),e}}:void 0,s(e,o,n)}}var y={debug:p};exports.configureNextJestPreview=async function(e){const s=await e();return s.transform&&(s.transform["^.+\\.(css|scss|sass)$"]="jest-preview/transforms/css",s.transform["^(?!.*\\.(js|jsx|mjs|cjs|ts|tsx|css|json)$)"]="jest-preview/transforms/file"),s.transformIgnorePatterns&&(s.transformIgnorePatterns=s.transformIgnorePatterns.filter((e=>"^.+\\.module\\.(css|sass|scss)$"!==e))),s.moduleNameMapper&&(delete s.moduleNameMapper["^.+\\.module\\.(css|sass|scss)$"],delete s.moduleNameMapper["^.+\\.(css|sass|scss)$"],delete s.moduleNameMapper["^.+\\.(png|jpg|jpeg|gif|webp|avif|ico|bmp|svg)$"]),s},exports.debug=p,exports.default=y,exports.jestPreviewConfigure=async function({externalCss:e=[],autoPreview:s=!1,publicFolder:t}={externalCss:[],autoPreview:!1}){s&&function(){const e=it;let s=m(it);s.each=e.each,s.only=m(e.only),s.skip=e.skip,s.todo=e.todo,s.concurrent=m(e.concurrent),it=s,test=s,fit=s.only}(),a.default.existsSync(d)||a.default.mkdirSync(d,{recursive:!0}),null==e||e.forEach((e=>{const s=`cache-${e.replace(/\//g,"___")}`,t=c.default.join(d,s);if(f(),e.endsWith(".scss")||e.endsWith(".sass")){const s=t.replace(/\.(scss|sass)$/,".css");o.exec(`${c.default.join(process.cwd(),"node_modules",".bin","sass")} ${e} ${s} --no-source-map`,(e=>{e&&console.log(e)}))}else a.default.copyFile(e,t,(e=>{if(e)throw e}))})),t&&(f(),a.default.writeFileSync(c.default.join(d,"cache-public.config"),t,{encoding:"utf-8",flag:"w"}))},exports.processCss=function(e,s){return s.endsWith(".module.css")?function(e,s){return{code:`const postcss = require('postcss');\nconst PostcssModulesPlugin = require('postcss-modules');\nconst cssSrc = ${JSON.stringify(e)};\n\nclass Token {\n  set(json) {\n    Object.keys(json).forEach((key) => {\n      this[key] = json[key];\n    });\n  }\n}\n\nconst exportedTokens = new Token();\n\npostcss(\n  PostcssModulesPlugin({\n    getJSON: (cssFileName, json, outputFileName) => {\n      exportedTokens.set(json);\n    },\n  }),\n)\n.process(cssSrc, { from: ${JSON.stringify(s)} })\n.then((result) => {\n  // TODO: Jest 24 (jest-environment-jsdom@24) not work. To investigate\n  const style = document.createElement('style');\n  style.type = 'text/css';\n  style.appendChild(document.createTextNode(result.css));\n  document.head.appendChild(style);\n});\n\nmodule.exports = exportedTokens;`}}(e,s):s.endsWith(".scss")||s.endsWith(".sass")?function(e,s){let t;try{t=require("sass")}catch(e){return console.log(e),{code:`module.exports = ${JSON.stringify(s)};`}}const n=t.compile(s).css;return{code:`const style = document.createElement('style');\nstyle.appendChild(document.createTextNode(${JSON.stringify(n)}));\ndocument.head.appendChild(style);\nmodule.exports = {}`}}(0,s):{code:`const relativeCssPath = "${u(s)}";\nconst link = document.createElement('link');\nlink.rel = 'stylesheet';\nlink.href = relativeCssPath;\ndocument.head.appendChild(link);\n\nmodule.exports = JSON.stringify(relativeCssPath);`}},exports.processFile=function(e,s){const t=u(s);return{code:`module.exports = ${JSON.stringify(t)};`}},exports.processFileCRA=function(e,s){const t=JSON.stringify(u(s));if(s.match(/\.svg$/)){return{code:`const React = require('react');\n    module.exports = {\n      __esModule: true,\n      default: ${t},\n      ReactComponent: React.forwardRef(function ${`Svg${i.default(c.default.parse(s).name,{pascalCase:!0})}`}(props, ref) {\n        return {\n          $$typeof: Symbol.for('react.element'),\n          type: 'svg',\n          ref: ref,\n          key: null,\n          props: Object.assign({}, props, {\n            children: ${t}\n          })\n        };\n      }),\n    };`}}return{code:`module.exports = ${t};`}};
